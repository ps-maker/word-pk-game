<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…è´¹ä¸­è‹±æ–‡PK</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        #loginBox { text-align: center; }
        #gameBox { display: none; }
        .word-card {
            padding: 15px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            background: #f8f9fa;
        }
        .matched {
            background: #ffebee !important;
            border-color: #ff6b81 !important;
        }
        #statusBar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="loginBox">
        <h2>å•è¯å¤§ä½œæˆ˜</h2>
        <input type="text" id="userName" placeholder="è¾“å…¥ä½ çš„åå­—">
        <button onclick="startGame()">å¼€å§‹åŒ¹é…</button>
    </div>

    <div id="gameBox">
        <div id="statusBar">
            å¯¹æ‰‹ï¼š<span id="rivalName">ç­‰å¾…ä¸­...</span><br>
            å¾—åˆ†ï¼š<span id="rivalScore">0</span>
        </div>
        <div id="cardGrid"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ===== é…ç½®åŒº =====
        const SUPABASE_URL = "ä½ çš„Supabaseé¡¹ç›®URL";
        const SUPABASE_KEY = "ä½ çš„Supabaseå…¬é’¥";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===== å®Œæ•´16ç»„æ•°æ® =====
        const FULL_DATA = [
            ["çœ¼ç¥æ¥è§¦å°‘æˆ–ä¸ä¸€è‡´", "Making little/inconsistent eye contact"],
            ["çœ‹ä¼¼ä¸æ³¨æ„è¯´è¯è€…", "Appearing not looking at/listening to people talking"],
            ["æå°‘åˆ†äº«å…´è¶£æˆ–æƒ…ç»ª", "Infrequently sharing interest/emotion"],
            ["å¯¹åå­—æˆ–å‘¼å”¤æ— ååº”æˆ–ååº”è¿Ÿé’", "Not responding/being slow to respond to one's name/verbal bids"],
            ["å¯¹è¯äº’åŠ¨å›°éš¾", "Having difficulties with back-and-forth conversation"],
            ["å•å‘è°ˆè®ºè¯é¢˜", "Talking without noticing others' interest or giving others a chance to respond"],
            ["è¡¨æƒ…åŠ¨ä½œä¸åè°ƒ", "Mismatched facial expressions/gestures"],
            ["è¯­è°ƒå¼‚å¸¸", "Unusual tone of voice"],
            ["éš¾ä»¥ç†è§£ä»–äººè§‚ç‚¹", "Having trouble understanding others' perspectives"],
            ["ç¤¾äº¤åœºæ™¯é€‚åº”å›°éš¾", "Difficulties adjusting to social situations"],
            ["æƒ³è±¡æ€§æ¸¸æˆæˆ–äº¤å‹éšœç¢", "Difficulties sharing in imaginative play or in making friends"],
            ["é‡å¤ç‰¹å®šè¡Œä¸ºæˆ–ä¸å¯»å¸¸è¡Œä¸º", "Repeating certain behaviors or having unusual behaviors"],
            ["å¯¹ç‰¹å®šä¸»é¢˜å¼ºçƒˆå…´è¶£", "Lasting intense interest in specific topics"],
            ["è¿‡åº¦å…³æ³¨ç§»åŠ¨çš„ç‰©ä½“æˆ–ç‰©ä½“çš„éƒ¨åˆ†", "Overly focused interest with moving objects or object parts"],
            ["å› æ—¥å¸¸å¾®å°å˜åŒ–è€Œçƒ¦èº", "Becoming upset by slight changes in a routine"],
            ["å¯¹æ„Ÿå®˜è¾“å…¥è¿‡åº¦æ•æ„Ÿæˆ–ä½æ•æ„Ÿ", "Over-/under-sensitive to sensory input"]
        ];

        // ===== æ¸¸æˆé€»è¾‘ =====
        let currentPlayer = { id: null, score: 0 };

        async function startGame() {
            const userName = document.getElementById('userName').value;
            if (!userName) return alert("è¯·è¾“å…¥åå­—");

            // 1. åˆ›å»ºç©å®¶è®°å½•
            const { data, error } = await supabase
                .from('players')
                .insert([{ name: userName, score: 0, status: 'waiting' }])
                .select();
            
            currentPlayer.id = data[0].id;
            
            // 2. åˆ‡æ¢ç•Œé¢
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('gameBox').style.display = 'block';

            // 3. å¼€å§‹åŒ¹é…
            setupRealtime();
        }

        function setupRealtime() {
            // å®æ—¶ç›‘å¬æ–°ç©å®¶
            supabase.channel('public:players')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public' },
                    async (payload) => {
                        if (payload.new.status === 'waiting' && payload.new.id !== currentPlayer.id) {
                            startBattle(payload.new.id);
                        }
                    }
                )
                .subscribe();
        }

        async function startBattle(rivalId) {
            // ç”Ÿæˆé¢˜ç›®
            const questions = FULL_DATA.sort(() => Math.random() - 0.5).slice(0, 10);
            
            // æ¸²æŸ“æ¸¸æˆç•Œé¢
            renderCards(questions);
            
            // ç›‘å¬å¯¹æ‰‹çŠ¶æ€
            supabase.channel(`room:${rivalId}`)
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'players' },
                    (payload) => {
                        if (payload.new.id === rivalId) {
                            document.getElementById('rivalName').textContent = payload.new.name;
                            document.getElementById('rivalScore').textContent = payload.new.score;
                        }
                    }
                )
                .subscribe();
        }

        function renderCards(questions) {
            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';
            
            // åˆå¹¶å¹¶æ‰“ä¹±é¢˜ç›®
            const allWords = questions.flatMap(pair => pair)
                .sort(() => Math.random() - 0.5)
                .map(word => `
                    <div class="word-card" onclick="handleClick('${word}', this)">
                        ${word}
                    </div>
                `).join('');
            
            grid.innerHTML = allWords;
        }

        let selected = [];
        async function handleClick(word, element) {
            if (element.classList.contains('matched')) return;

            selected.push({ word, element });
            element.style.background = '#e3f2fd';

            if (selected.length === 2) {
                const isMatched = checkMatch(selected[0].word, selected[1].word);
                
                // æ›´æ–°åˆ†æ•°
                const newScore = isMatched ? currentPlayer.score + 10 : Math.max(0, currentPlayer.score -5);
                const { error } = await supabase
                    .from('players')
                    .update({ score: newScore })
                    .eq('id', currentPlayer.id);

                // æ›´æ–°ç•Œé¢
                if (isMatched) {
                    selected.forEach(c => c.element.classList.add('matched'));
                    currentPlayer.score = newScore;
                    if (currentPlayer.score >= 100) alert("ğŸ‰ ä½ èµ¢äº†ï¼");
                } else {
                    currentPlayer.score = newScore;
                }
                selected = [];
            }
        }

        function checkMatch(a, b) {
            return FULL_DATA.some(pair => 
                (pair[0] === a && pair[1] === b) || 
                (pair[0] === b && pair[1] === a)
        }
    </script>
</body>
</html>